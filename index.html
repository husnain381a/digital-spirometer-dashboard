<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Spirometer Live Dashboard</title>
  <style>
    :root {
      --bg: #fff;
      --text: #111;
      --card: #fafafa;
      --border: #e5e5e5;
      --green: #22c55e;
      --yellow: #f59e0b;
      --blue: #2563eb;
    }

    body {
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
    }

    h1 {
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      margin: 0 0 16px;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
    }

    @media(max-width:900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
    }

    .video-wrap {
      width: 70%;
      margin: auto;
      position: relative;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    video,
    canvas#overlay {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .labels {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .label {
      padding: 8px 14px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-weight: 600;
    }

    .g {
      color: var(--green);
    }

    .y {
      color: var(--yellow);
    }

    .b {
      color: var(--blue);
    }

    .num {
      margin-left: 6px;
      font-weight: 700;
    }

    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    button {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: var(--blue);
      color: #fff;
      cursor: pointer;
    }

    input[type=range] {
      width: 140px;
    }

    .charts {
      display: grid;
      gap: 14px;
    }

    canvas.chart {
      width: 100%;
      height: 150px !important;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <h1>Digital Spirometer - Live Dashboard</h1>
  <div class="container">
    <div>
      <div class="panel video-wrap">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
      <div class="panel" style="margin-top:14px;">
        <div class="labels">
          <div class="label g">Green: <span id="valG" class="num">0</span> mL</div>
          <div class="label y">Yellow: <span id="valY" class="num">0</span> mL</div>
          <div class="label b">Blue: <span id="valB" class="num">0</span> mL</div>
        </div>
        <div class="controls">
          <button id="startBtn">Start</button>
          <button id="stopBtn">Stop</button>
          <label>Ref Y: <input id="refY" type="range" min="120" max="460" value="400" /></label>
          <label>Pixels/500mL: <input id="pp500" type="range" min="30" max="300" value="100" /></label>
        </div>
      </div>
    </div>

    <div>
      <div class="panel">
        <div class="charts">
          <canvas id="chartG" class="chart"></canvas>
          <canvas id="chartY" class="chart"></canvas>
          <canvas id="chartB" class="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const thresholds = { green: { h1: 45, h2: 80, s: 58, v: 58 }, yellow: { h1: 22, h2: 32, s: 62, v: 62 }, blue: { h1: 100, h2: 130, s: 70, v: 47 } };
    const video = document.getElementById('video'), overlay = document.getElementById('overlay'); const ctx = overlay.getContext('2d'); overlay.width = 640; overlay.height = 480;
    const valG = document.getElementById('valG'), valY = document.getElementById('valY'), valB = document.getElementById('valB');
    const refYSlider = document.getElementById('refY'), pp500Slider = document.getElementById('pp500');

    function createChart(el, label, color, max) { return new Chart(el.getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: 'transparent', tension: .25 }] }, options: { animation: false, responsive: true, scales: { x: { display: false }, y: { beginAtZero: true, suggestedMax: max } }, plugins: { legend: { display: false } } } }); }
    const chartG = createChart(document.getElementById('chartG'), 'Green', 'rgb(34,197,94)', 600);
    const chartY = createChart(document.getElementById('chartY'), 'Yellow', 'rgb(245,158,11)', 900);
    const chartB = createChart(document.getElementById('chartB'), 'Blue', 'rgb(37,99,235)', 1200);

    let streaming = false, raf = null, startTime = null;

    function rgbToHsv(r, g, b) { r /= 255; g /= 255; b /= 255; let max = Math.max(r, g, b), min = Math.min(r, g, b); let h = 0, s = 0, v = max, d = max - min; s = max === 0 ? 0 : d / max; if (max !== min) { switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; }h *= 60; } return [h, s * 100, v * 100]; }

    function detectColor(frame, w, h, t) {
      const d = frame.data; let sumX = 0, sumY = 0, count = 0, minX = w, minY = h, maxX = 0, maxY = 0;
      for (let y = 0; y < h; y += 2) {
        for (let x = 0; x < w; x += 2) {
          const i = (y * w + x) * 4; let R = d[i], G = d[i + 1], B = d[i + 2]; const [H, S, V] = rgbToHsv(R, G, B);
          const match = (t.h1 <= t.h2) ? (H >= t.h1 && H <= t.h2) : (H >= t.h1 || H <= t.h2);
          if (match && S >= t.s && V >= t.v) { sumX += x; sumY += y; count++; if (x < minX) minX = x; if (y < minY) minY = y; if (x > maxX) maxX = x; if (y > maxY) maxY = y; }
        }
      }
      if (count === 0) return null;
      const cx = Math.round(sumX / count), cy = Math.round(sumY / count); const bw = maxX - minX || 1, bh = maxY - minY || 1; const aspect = bw / bh;
      const boxArea = bw * bh; const density = count / boxArea;
      if (aspect < 0.75 || aspect > 1.35) return null;
      if (density < 0.25 || density > 0.95) return null;
      if (count < 60 || count > 5000) return null;
      const circ = density; if (circ < 0.40 || circ > 0.88) return null;
      return { cx, cy, area: count, w: bw, h: bh, aspect, density };
    }

    function computeVolume(c, refY, pp, max) { if (!c) return 0; const disp = Math.max(0, refY - c.cy); return Math.min(disp * (500 / pp), max); }

    function frameLoop() {
      if (!streaming) return; const w = overlay.width, h = overlay.height; ctx.drawImage(video, 0, 0, w, h); const frame = ctx.getImageData(0, 0, w, h);
      const cG = detectColor(frame, w, h, thresholds.green), cY = detectColor(frame, w, h, thresholds.yellow), cB = detectColor(frame, w, h, thresholds.blue);
      const refY = parseInt(refYSlider.value); ctx.strokeStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.moveTo(0, refY); ctx.lineTo(w, refY); ctx.stroke();
      const pp = parseInt(pp500Slider.value);
      const vG = computeVolume(cG, refY, pp, 600), vY = computeVolume(cY, refY, pp, 900), vB = computeVolume(cB, refY, pp, 1200);
      function mark(c, col) { if (!c) return; ctx.strokeStyle = col; ctx.beginPath(); ctx.arc(c.cx, c.cy, 16, 0, 6.28); ctx.stroke(); }
      mark(cG, 'rgb(34,197,94)'); mark(cY, 'rgb(245,158,11)'); mark(cB, 'rgb(37,99,235)');
      valG.textContent = vG.toFixed(1); valY.textContent = vY.toFixed(1); valB.textContent = vB.toFixed(1);
      const t = ((Date.now() - startTime) / 1000).toFixed(2);
      function push(ch, v) { ch.data.labels.push(t); ch.data.datasets[0].data.push(v); if (ch.data.labels.length > 200) { ch.data.labels.shift(); ch.data.datasets[0].data.shift(); } ch.update('none'); }
      push(chartG, vG); push(chartY, vY); push(chartB, vB);
      raf = requestAnimationFrame(frameLoop);
    }

    async function start() { if (streaming) return; try { const s = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } }); video.srcObject = s; await video.play(); streaming = true; startTime = Date.now(); raf = requestAnimationFrame(frameLoop); } catch (e) { alert('Camera blocked. Use HTTPS or localhost'); } }
    function stop() { if (!streaming) return; const s = video.srcObject; if (s) s.getTracks().forEach(t => t.stop()); streaming = false; if (raf) cancelAnimationFrame(raf); }

    document.getElementById('startBtn').onclick = start; document.getElementById('stopBtn').onclick = stop;
  </script>
</body>

</html>